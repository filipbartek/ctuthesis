\begin{frame}{Neural Precedence Recommender}
\centering
\input{presentation/gv/RankNetPrecedence}
%\digraph[scale=0.4]{PresentationArchitectureOverview}{
%graph [splines=ortho, ranksep=0.25];
%node [shape=box, fontsize=14, width=0, height=0];
%Problem [label="First-order logic problem"];
%Graphifier [style=rounded, label="Graph constructor"];
%g [label="Graph"];
%GCN [style=<rounded,bold>, label="Graph convolutional network"];
%SymbolEmbedding [label="Symbol embeddings"];
%SymbolCostModel [style=<rounded,bold>, label="Output layer"];
%SymbolCost [label="Symbol costs"];
%Problem -> Graphifier -> g -> GCN;
%GCN -> SymbolEmbedding -> SymbolCostModel -> SymbolCost [penwidth=3];
%subgraph cluster_prediction {
%	label="Prediction";
%	style=dashed;
%	Sort [style=rounded, label="Sort"];
%	Precedence [label=<Recommended precedence>];
%	Sort -> Precedence;
%}
%SymbolCost -> Sort;
%subgraph cluster_training {
%	label="Training";
%	style=dashed;
%	{ rank = same;
%	pi [label=<Precedence &pi;>];
%	rho [label=<Precedence &rho;>];
%	}
%	LossFunction [style=rounded, label="Loss function"];
%	Loss [label="Loss value"];
%	pi -> LossFunction:nw;
%	rho -> LossFunction:ne;
%	LossFunction -> Loss [penwidth=3];
%}
%SymbolCost -> LossFunction [penwidth=3];
%}
\end{frame}

\begin{frame}
\frametitle{Training: Precedence cost}
$c_i$ is the cost of the $i$-th symbol.

\begin{block}{Cost of symbol precedence $\pi$ over signature of length $n$}
\begin{equation*}
C(\pi) = \frac{2}{n(n+1)} \sum_{i=1}^n i \cdot c_{\pi(i)}
\end{equation*}
\end{block}

\begin{lemma}[Precedence cost minimization]
The precedence cost $C$ is minimized by any precedence that sorts the symbols by their costs in non-increasing order:
$$
\argmin_{\rho \in \mathrm{Perm}(n)} C(\rho) = \argsort^- (c_1, \ldots, c_n)
$$
\end{lemma}

\end{frame}

\begin{frame}
\frametitle{Training: Loss function}


\begin{block}{Loss on training example $\Better{\PrecBetter}{\PrecWorse}{P}$}
Precedence $\PrecBetter$ is better than precedence $\PrecWorse$ for problem $P$.

$C(\pi)$ is the predicted cost of precedence $\pi$.

\begin{equation*}
\loss(P, \PrecBetter, \PrecWorse) = - \log \sigmoid (C(\PrecWorse) - C(\PrecBetter))
\end{equation*}

\centering
% https://pgf-tikz.github.io/pgf/pgfmanual.pdf : 94. Mathematical Expressions
\begin{tikzpicture}
\begin{axis}[
    domain=-12:12,
    xmin=-12,
    xmax=12,
    ymin=-1,
    ymax=11,
    samples=100,
    xlabel={$C(\PrecWorse) - C(\PrecBetter)$},
    ylabel={$\loss(P, \PrecBetter, \PrecWorse)$},
    scale only axis,
    width=0.25\textwidth,
    height=0.125\textwidth
]
%\addplot[gray] {0};
%\addplot[gray] {-x};
\addplot[] {-ln(\FuncSigmoid(x))};
\end{axis}
\end{tikzpicture}
\end{block}

\end{frame}

\begin{frame}
\frametitle{Evaluation}

\fontsize{10pt}{12}\selectfont

\centering
\begin{tabular}{l|ll|rl}

Symbol cost model & \multicolumn{2}{l}{Success count\footnote{Total number of validation problems: \num{7648}. Number of repetitions: 5.}} & \multicolumn{2}{l}{Improvement} \\
& Mean & Std & Absolute & Relative \\

\hline


\acrshort{gcn} (pred. and func.) &
% VML-706
\num{3951.6} &
\num[round-mode=places,round-precision=2]{1.624807680927192} &
%\SI{51.69}{\percent} &
+182.0 &
\num[round-mode=places,round-precision=3]{1.048280985} \\


\acrshort{gcn} (predicate only) &
% Success rate: mean: 0.513023013, std: 0.000292887
% Evaluation results: https://ui.neptune.ai/filipbartek/vampire-ml/e/VML-553
% Total: validation_solver_eval/all/problems/measured&split&category: 7648
% Difference in success count from baseline: 154 ~ 0.020135983
% Estimated difference from baseline (estimate on 891 problems): 0.021099888
% Checkpoint: outputs/2021-02-06/14-55-41/tf_ckpts/epoch/weights.00079-0.61.tf VML-540 0.511785
\num{3923.6} &
% Success mean: validation_solver_eval/all/success/count/mean: 3923.6
\num{2.24} &
% Success std: validation_solver_eval/all/success/count/std 2.24
%\SI{51.30}{\percent} &
% Success rate: 0.513023013
+154.0 &
\num[round-mode=places,round-precision=3]{1.040853141} \\


\acrshort{gcn} (function only) &
% Final evaluation: VML-677
% Evaluated checkpoint: outputs/2021-02-16/12-28-14/tf_ckpts/epoch/weights.00289.tf
% Results file: sftp://cluster.ciirc.cvut.cz/home/bartefil/git/vampire-ml/outputs/2021-02-17/12-01-09/solver_eval/symbol_cost/epoch_-1/logs.yaml
% Total: val/all/problems/measured&split&category: 7648
\num{3874.2} &
% Success mean: val/all/success/count/mean: 3874.2
\num[round-mode=places,round-precision=2]{1.8330302779823362} &
% Success std: val/all/success/count/mean: 1.8330302779823362
%\SI{50.66}{\percent} &
% Success rate: val/all/success/count/mean: 0.5065638075313807
+104.6 &
\num[round-mode=places,round-precision=3]{1.027748302} \\


%Simple (predicate only) &
% https://ui.neptune.ai/filipbartek/vampire-ml/e/VML-737
%\num{3827.2} &
%\num[round-mode=places,round-precision=2]{1.9390719429665317} &
%\SI{50.04}{\percent} &
%+57.6 &
%\num[round-mode=places,round-precision=3]{1.015280136} \\
% Final vector from PAAR paper: [0,0.429306921481749,0.57069307851825,0,0,0,0,0,0,0,0,0]
% Source: https://docs.google.com/spreadsheets/d/1HSsC7piUAtWt6uwA9SYOX5vmiF0Ab3Ae4FPyGsDALIg/edit#gid=99404775


%Frequency (regular \acrshort{kbo}) &
%\texttt{vampire -lcm standard} &
%\num{3823.0} &
%\num[round-mode=places,round-precision=2]{3.40587727318528} &
%\SI[round-mode=places,round-precision=2]{49.9869247}{\percent} &
%+53.4 &
%\num[round-mode=places,round-precision=3]{1.014165959} \\
% VML-741


Frequency (baseline) &
%\texttt{vampire -lcm predicate} &
% Success rate: mean: 0.492887029, std: 0.000401412
% https://ui.neptune.ai/filipbartek/vampire-ml/e/VML-490
% sftp://cluster.ciirc.cvut.cz/home/bartefil/git/vampire-ml/outputs/2021-02-04/17-17-38
% /home/filip/projects/vampire-ml/vampire-ml/outputs/2021-02-09/12-13-43
% Row: 'val&graphified&solver_eval'
% Problems total: 7648
% Success rate: 0.492887029
\num{3769.6} &
\num{3.07} &
%\SI{49.29}{\percent} &
0.0 &
\num[round-mode=places,round-precision=3]{1.0} \\

\end{tabular}

\end{frame}

\begin{frame}
\frametitle{Summary}
\begin{itemize}
\item \Acrshort{gcn} over a graph representation of a \acrshort{fol} problem predicts symbol costs
\item Sorting symbols by symbol costs yields a precedence
\item Training is performed on oriented precedence pairs ``$\Better{\PrecBetter}{\PrecWorse}{P}$'' \\
(``Precedence $\PrecBetter$ is better than precedence $\PrecWorse$ in problem $P$.'')
\item Combination of two \acrshortpl{gcn} outperforms the ``frequency'' heuristic by \SI{4.8}{\percent}
\end{itemize}
\end{frame}
